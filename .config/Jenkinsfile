
pipeline {
  agent {
    label 'linux'
  }

  environment {
    ARTIFACT_NAME = 'agbar-fh-kafka2kafka'
    NODE_VERSION = '20.11.1'
    // Deja aquí la URL pública de tu repo GitHub
    GIT_REPO_URL = 'https://github.com/AntonioMataMarco/agbar-fh-kafka2kafka.git'
  }

  options {
    skipDefaultCheckout true
    timestamps()
  }

  stages {

    stage('Checkout GitHub') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: env.GIT_REPO_URL
            // Sin credentialsId, porque es público
          ]]
        ])
      }
    }

    stage('Install dependencies') {
      steps {
        sh '''
          # Verifica que Node.js esté instalado en el agente
          node -v || (echo "Node.js no encontrado" && exit 1)

          # Instala dependencias con yarn
          yarn install --registry https://registry.npmjs.org
        '''
      }
    }

    stage('Build artifact') {
      steps {
        sh '''
          yarn run build:production
          yarn install --production
          zip -r ${ARTIFACT_NAME}.zip artifacts
        '''
        archiveArtifacts artifacts: "${ARTIFACT_NAME}.zip", fingerprint: true
      }
    }

  }

  post {
    always {
      cleanWs()
    }
  }
}
