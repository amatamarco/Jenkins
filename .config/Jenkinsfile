pipeline {
    agent {
        docker {
            image 'node:20.11.1-buster' // Ya incluye `tsc` y puedes instalar `zip`
            args '-u root'              // Ejecuta como root dentro del contenedor
        }
    }

    environment {
        ARTIFACT_NAME = 'agbar-fh-kafka2kafka'
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    stages {
        stage('Install Tools') {
            steps {
                sh '''
                apt-get update && apt-get install -y zip
                npm install -g typescript
                '''
            }
        }

        stage('Install Production Dependencies') {
            steps {
                sh 'yarn install'
            }
        }

        stage('Build Artifact') {
            steps {
                sh 'yarn run build:production'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'yarn install --production'
            }
        }

        stage('Prepare Artifacts') {
            matrix {
                axes {
                    axis {
                        name 'PLATFORM'
                        values 'linux', 'windows'
                    }
                }
                stages {
                    stage('Copy node_modules') {
                        steps {
                            sh '''
                            mkdir -p artifacts/${PLATFORM}/node_modules
                            cp -r node_modules/* artifacts/${PLATFORM}/node_modules/
                            '''
                        }
                    }

                    stage('Archive Artifacts') {
                        steps {
                            sh '''
                            mkdir -p ${ARTIFACT_NAME}
                            cd artifacts && zip -r ../${ARTIFACT_NAME}/${ARTIFACT_NAME}-${PLATFORM}.zip ${PLATFORM}
                            '''
                        }
                    }
                }
            }
        }

        stage('Publish Artifacts') {
            steps {
                archiveArtifacts artifacts: "${ARTIFACT_NAME}/*.zip", fingerprint: true
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
    }
}
